---
title: "Extended Canham model"
author: "Sarah Popov"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r canham extended setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE)

# This RMD is NOT intended as a standalone script, but rather to be sourced
# from models.Rmd. The data used in this Rmd file is generated in models.Rmd
# and binomial_sr.Rmd.
```

# Extended Canham et al. (2021) model

In this initial analysis, the model is kept relatively simple: the exact same model as in Canham et al. (2021) is used, but a "north vs. south" term is added. The response variable will be the log-transformed count of WESA for that location (total count for that location/day * the predicted WESA ratio generated by the bGLMM above).

### Base model

Response variable:

* `log_wesa` - Log-transformed predicted WESA count

Predictor variables:

* `year_c` - Scale-transformed survey year
* `dos` - Scale-transformed ordinal date, aka Day of Season

```{r wesa ~ base model}
# This assumes binomial_sr has already been run, and predicted WESA ratios
# have already been calculated and added to dat

# Base model
# Response variable: log-transformed predicted WESA count (log_wesa)
# Predictor variables:
#   - Scale-transformed survey year (year_c)
#   - Scale-transformed ordinal date, aka Day of Season (dos)
wesa_base_mod <- lmerTest::lmer(log_wesa ~ year_c + dos + I(dos^2) + (dos + I(dos^2) | year),
                            data = dat,
                            REML = TRUE)

summary(wesa_base_mod)
```

\newpage
### Full model

```{r reduce dat to complete cases}
# Reduce dataset to our variables of interest, and only keep 
# complete cases
dat2 <- dat[,c("predicted_wesa", "log_wesa", "year", "year_c", "dos", "elev_range", "total_precip", "mean_temp", "flow", "u", "v", "n_s")]
dat2 <- dat2[complete.cases(dat2),]
```

**NOTE**: at the time of this writing, `IR` is *unavaible* in this model. I have not gotten any response from the team that manages the UBC Totem Station data. Given it was not a significant variable in Canham et al. (2021), I do not believe it is urgent to acquire this particular data.

Response variable:

* `log_wesa` - Log-transformed predicted WESA count

Predictor variables:

* `year_c` - Scale-transformed survey year
* `dos` - Scale-transformed ordinal date, aka Day of Season
* `elev_range` - Tidal amplitude (m)
* `total_precip` - Total daily precipitation (mm)
* `mean_temp` - Daily mean temperature (CÂ°)
* `flow` - Fraser River discarge (m^3/s)
* `u`, `v` - Westerly and Southerly wind vectors (km/h)
* `n_s` - Location ('North' or 'South')

Additionally, the dataset is reduced down to only complete cases of all predictor variables of interest (`r nrow(dat)` -> `r nrow(dat2)`).

```{r wesa ~ canham + n_s model, warning=FALSE}
wesa_full_mod <- lmerTest::lmer(log_wesa ~ year_c + dos + I(dos^2) + scale(elev_range) + scale(total_precip) + scale(mean_temp) + scale(flow) + scale(u) + scale(v) + n_s + (dos + I(dos^2) | year) + (scale(flow) | n_s),
                            data = dat2,
                            REML = TRUE)
summary(wesa_full_mod)
```

### Backwards step-wise selection

```{r selection}
lmerTest::step(wesa_full_mod, 
               direction = "backward", 
               reduce.random = F,
               keep=c("year_c", "dos", "I(dos^2)"))
```
\newpage
### Summary of best-fit model

```{r summary n_s best fit, warning=FALSE}
wesa_best_fit <- lmerTest::lmer(log_wesa ~ year_c + dos + I(dos^2) + scale(elev_range) + scale(v) + (dos + I(dos^2) | year) + (scale(flow) | n_s),
                                data = dat2,
                                REML = TRUE)

summary(wesa_best_fit)
```

\newpage
### Check assumptions of best fit model

```{r add predicted n-s values to dat2, include=FALSE}
# Add predicted values to dat2
dat2$predicted_log_wesa <- fitted(wesa_best_fit)
dat2$resids <- resid(wesa_best_fit)
```

```{r wesa n-s plot: observed vs predicted}
ggplot(dat2, aes(x = predicted_log_wesa, y = log_wesa)) +
  geom_point() + 
  ggtitle("Observed vs. Predicted values") +
  xlab("Observed") + 
  ylab("Predicted") +
  theme_minimal()
```


```{r wesa n-s plot: heteroskedasticity}
ggplot(dat2, aes(x = predicted_log_wesa, y = resids)) +
  geom_point() + 
  ggtitle("Heteroskedasticity",
          subtitle = "Fitted values vs. Residuals") +
  xlab("Fitted") + 
  ylab("Residuals") +
  theme_minimal()
```


```{r wesa n-s plot: qq plot}
ggplot(dat2, aes(sample = resids)) +
  stat_qq() + 
  stat_qq_line() +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  ggtitle("Quantile-Quantile") +
  xlab("Theoretical") + 
  ylab("Sample") +
  theme_minimal()
```

